<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>âœ¦ Mystic Tarot âœ¦</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--gold:#d4a843;--gold-l:#f0d68a;--gold-d:#8b6914;--bg:#0a0612;--bg2:#1a0f2e;--purple:#6b3fa0;--text:#e8dcc8;--text2:#a99e8d;--cw:100;--ch:174;--nav-h:56px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh;overflow:hidden}
.nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);z-index:100;background:rgba(10,6,18,.94);backdrop-filter:blur(16px);border-top:1px solid rgba(212,168,67,.15);display:flex;align-items:center;justify-content:space-around}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;color:var(--text2);cursor:pointer;font-family:inherit;font-size:.62rem;padding:6px 16px;transition:color .3s;position:relative}
.nav-btn.active{color:var(--gold)}
.nav-btn.active::before{content:'';position:absolute;top:-1px;left:20%;right:20%;height:2px;background:var(--gold);border-radius:0 0 2px 2px}
.nav-btn svg{width:22px;height:22px;fill:currentColor}
.page{position:fixed;inset:0;bottom:var(--nav-h);display:none;flex-direction:column;overflow:hidden;background:var(--bg)}
.page.active{display:flex}
.page-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.hdr{text-align:center;padding:14px 16px 6px;flex-shrink:0}
.hdr h1{font-family:'Cinzel',serif;font-size:clamp(1.1rem,4vw,1.7rem);letter-spacing:.18em;background:linear-gradient(135deg,var(--gold-d),var(--gold),var(--gold-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr .sub{font-size:.75rem;color:var(--text2);margin-top:2px;font-family:'Cormorant Garamond',serif;font-style:italic}
#canvasWrap{flex:1;position:relative;width:100%;min-height:0}
#tarotCanvas{width:100%;height:100%;display:block;touch-action:none}
.ctrl{flex-shrink:0;padding:8px 16px 10px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:6px}
.btn{font-family:'Cinzel',serif;font-size:.82rem;background:transparent;color:var(--gold);border:1px solid var(--gold);padding:9px 30px;border-radius:28px;cursor:pointer;letter-spacing:.12em;transition:all .3s}
.btn:hover{background:rgba(212,168,67,.1);box-shadow:0 0 20px rgba(212,168,67,.2)}
.btn:disabled{opacity:.3;pointer-events:none}
.btn-g{background:var(--gold);color:var(--bg);font-weight:700}
.btn-g:hover{background:var(--gold-l)}
.btn-sm{font-size:.72rem;padding:6px 18px}
.stxt{font-size:.75rem;color:var(--gold-l);min-height:1.2em;letter-spacing:.04em}
.dots{display:flex;gap:8px;justify-content:center}
.dot{width:10px;height:10px;border-radius:50%;border:1.5px solid var(--gold);transition:all .4s}
.dot.on{background:var(--gold);box-shadow:0 0 8px rgba(212,168,67,.5)}
.qarea{flex-shrink:0;padding:0 16px 6px}
.qinput{width:100%;background:rgba(26,15,46,.5);border:1px solid rgba(212,168,67,.2);border-radius:10px;padding:9px 12px;color:var(--text);font-family:inherit;font-size:.82rem;resize:none;outline:none;min-height:40px;max-height:72px}
.qinput:focus{border-color:rgba(212,168,67,.5)}
.qinput::placeholder{color:var(--text2);opacity:.5}
/* Result */
.rov{position:fixed;inset:0;z-index:200;background:rgba(10,6,18,.96);backdrop-filter:blur(16px);display:none;flex-direction:column}
.rov.show{display:flex}
.rov-h{flex-shrink:0;padding:16px;text-align:center;border-bottom:1px solid rgba(212,168,67,.1)}
.rov-h h2{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold);letter-spacing:.12em}
.rov-b{flex:1;overflow-y:auto;padding:14px;-webkit-overflow-scrolling:touch}
.rov-f{flex-shrink:0;padding:10px 16px 16px;text-align:center;display:flex;gap:10px;justify-content:center}
.rcrow{display:flex;gap:8px;overflow-x:auto;padding:6px 0 14px;justify-content:center;flex-wrap:wrap}
.rcm{width:215px;flex-shrink:0;text-align:center}
.rcm img{width:200px; height:330px; border-radius:4px;border:1px solid rgba(212,168,67,.3);box-shadow:0 2px 8px rgba(0,0,0,.4)}
.rcm .p{font-size:1rem;color:var(--text2);margin-top:3px}
.rcm .n{font-size:1rem;color:var(--gold-l);margin-top:1px;line-height:1.2}
.rcm .d{font-size:1rem;margin-top:1px}
.air{background:rgba(26,15,46,.35);border:1px solid rgba(212,168,67,.1);border-radius:10px;padding:14px;margin-top:10px;font-size:.82rem;line-height:1.7;white-space:pre-wrap}
.ail{text-align:center;padding:28px;color:var(--gold);font-style:italic}
.ail::after{content:'';display:inline-block;width:14px;height:14px;border:2px solid var(--gold);border-top-color:transparent;border-radius:50%;animation:sp .8s linear infinite;margin-left:6px;vertical-align:middle}
@keyframes sp{to{transform:rotate(360deg)}}
.aw{background:rgba(200,50,50,.12);border:1px solid rgba(200,80,80,.25);border-radius:8px;padding:10px;margin:10px 0;font-size:.78rem;color:#e88;text-align:center}
.aw a{color:var(--gold);text-decoration:underline}
/* Settings */
.sgrp{background:rgba(26,15,46,.35);border:1px solid rgba(212,168,67,.08);border-radius:10px;padding:14px;margin:0 16px 14px}
.sgrp h3{font-family:'Cinzel',serif;font-size:.82rem;color:var(--gold);letter-spacing:.08em;margin-bottom:10px}
.sgrp label{display:block;font-size:.75rem;color:var(--text2);margin-bottom:5px}
.sinput{width:100%;background:rgba(10,6,18,.5);border:1px solid rgba(212,168,67,.2);border-radius:8px;padding:9px 11px;color:var(--text);font-family:inherit;font-size:.82rem;outline:none}
.sinput:focus{border-color:rgba(212,168,67,.5)}
.spgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.spopt{background:rgba(10,6,18,.4);border:1px solid rgba(212,168,67,.12);border-radius:8px;padding:9px;cursor:pointer;text-align:center;transition:all .3s;font-size:.75rem;color:var(--text2)}
.spopt.act{border-color:var(--gold);color:var(--gold);background:rgba(212,168,67,.07)}
.spopt .sn{font-family:'Cinzel',serif;font-size:.68rem;letter-spacing:.06em}
.spopt .sc{font-size:.58rem;opacity:.5;margin-top:2px}
.svd{font-size:.7rem;color:#7be854;text-align:center;margin-top:6px;opacity:0;transition:opacity .3s}
.svd.show{opacity:1}
/* History */
.hlist{padding:10px 16px}
.hempty{text-align:center;padding:36px 18px;color:var(--text2);font-style:italic;font-size:.82rem}
.hitem{background:rgba(26,15,46,.35);border:1px solid rgba(212,168,67,.08);border-radius:10px;padding:12px;margin-bottom:9px;cursor:pointer;transition:border-color .3s}
.hitem:hover{border-color:rgba(212,168,67,.25)}
.htop{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.hdate{font-size:.6rem;color:var(--text2)}
.hsp{font-family:'Cinzel',serif;font-size:.62rem;color:var(--gold);letter-spacing:.06em}
.hq{font-size:.76rem;color:var(--text);line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.hchips{display:flex;gap:3px;margin-top:5px;flex-wrap:wrap}
.hchip{font-size:.52rem;background:rgba(212,168,67,.08);color:var(--gold-l);padding:2px 5px;border-radius:3px;white-space:nowrap}
@media(max-width:480px){:root{--cw:62;--ch:108;--nav-h:50px}.hdr h1{font-size:1rem}.btn{padding:7px 22px;font-size:.75rem}}
@media(min-width:768px){:root{--cw:110;--ch:191}}
@media(min-width:1200px){:root{--cw:120;--ch:209}.page,.nav,.rov{max-width:900px;left:50%;right:auto;width:100%;transform:translateX(-50%)}}
</style>
</head>
<body>
<nav class="nav">
<button class="nav-btn active" data-p="tarot" onclick="showPage('tarot')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l7 3.5v7.64l-7 3.5-7-3.5V7.68l7-3.5z"/><circle cx="12" cy="12" r="2"/></svg><span>íƒ€ë¡œ</span></button>
<button class="nav-btn" data-p="history" onclick="showPage('history')"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 00-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7a6.99 6.99 0 01-4.94-2.06l-1.42 1.42A8.96 8.96 0 0013 21a9 9 0 000-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>ë‚´ì—­</span></button>
<button class="nav-btn" data-p="settings" onclick="showPage('settings')"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.48.48 0 00-.48-.41h-3.84a.48.48 0 00-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87a.48.48 0 00.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.6 3.6 0 0112 15.6z"/></svg><span>ì„¤ì •</span></button>
</nav>
<div class="page active" id="pg-tarot">
<div class="hdr"><h1>âœ¦ Mystic Tarot âœ¦</h1><div class="sub" id="spLabel">ì“°ë¦¬ ì¹´ë“œ (3ì¥)</div></div>
<div class="qarea"><textarea class="qinput" id="qInput" placeholder="ì ì„ ë³´ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea></div>
<div id="canvasWrap"><canvas id="tarotCanvas"></canvas></div>
<div class="ctrl" id="ctrlArea">
<div class="dots" id="dotRow"></div>
<div class="stxt" id="stxt">ì¹´ë“œë¥¼ ì…”í”Œí•˜ì„¸ìš”</div>
<button class="btn btn-g" id="mainBtn" onclick="onMain()">âœ¦ ì…”í”Œí•˜ê¸° âœ¦</button>
</div>
</div>
<div class="page" id="pg-history"><div class="hdr"><h1>âœ¦ íƒ€ë¡œ ë‚´ì—­ âœ¦</h1><div class="sub">ê³¼ê±°ì˜ ì ìˆ  ê¸°ë¡</div></div><div class="page-scroll"><div class="hlist" id="hList"></div></div></div>
<div class="page" id="pg-settings"><div class="hdr"><h1>âœ¦ ì„¤ì • âœ¦</h1><div class="sub">íƒ€ë¡œ í™˜ê²½ì„ ì„¤ì •í•˜ì„¸ìš”</div></div>
<div class="page-scroll" style="padding-top:10px">
<div class="sgrp"><h3>âœ¦ Gemini AI API Key</h3><label>Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤</label><input type="password" class="sinput" id="apiInput" placeholder="AIza..."><div style="margin-top:7px;text-align:right"><button class="btn btn-sm" onclick="saveKey()">ì €ì¥</button></div><div class="svd" id="keySvd">âœ“ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div></div>
<div class="sgrp"><h3>âœ¦ ìŠ¤í”„ë ˆë“œ ì„ íƒ</h3><div class="spgrid" id="spGrid"></div><div class="svd" id="spSvd">âœ“ ìŠ¤í”„ë ˆë“œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤</div></div>
</div></div>
<div class="rov" id="rov">
<div class="rov-h"><h2 id="rovT">âœ¦ íƒ€ë¡œ í•´ì„ âœ¦</h2></div>
<div class="rov-b" id="rovB"></div>
<div class="rov-f"><button class="btn" onclick="closeR()">ë‹«ê¸°</button><button class="btn btn-g" onclick="restart()">ë‹¤ì‹œ ë½‘ê¸°</button></div>
</div>
<script>
// â•â•â•â•â•â•â• DECK â•â•â•â•â•â•â•
const W='https://upload.wikimedia.org/wikipedia/commons/';
const D=[
{id:'m0',n:'The Fool',img:W+'9/90/RWS_Tarot_00_Fool.jpg',t:'major',m:'ìƒˆë¡œìš´ ì‹œì‘, ëª¨í—˜, ììœ ',r:'ë¬´ëª¨í•¨, ë°©í–¥ ìƒì‹¤, ê²½ì†”'},
{id:'m1',n:'The Magician',img:W+'d/de/RWS_Tarot_01_Magician.jpg',t:'major',m:'ì°½ì¡°ë ¥, ì˜ì§€ë ¥, ê¸°ìˆ ',r:'ì†ì„ìˆ˜, ì¬ëŠ¥ ë‚­ë¹„'},
{id:'m2',n:'High Priestess',img:W+'8/88/RWS_Tarot_02_High_Priestess.jpg',t:'major',m:'ì§ê´€, ì‹ ë¹„, ë‚´ë©´ì˜ ì§€í˜œ',r:'ë¹„ë°€, ì§ê´€ ë¬´ì‹œ'},
{id:'m3',n:'The Empress',img:W+'d/d2/RWS_Tarot_03_Empress.jpg',t:'major',m:'í’ìš”, ëª¨ì„±, ìì—°ì˜ ì¶•ë³µ',r:'ì˜ì¡´, ì°½ì¡°ë ¥ ë¶€ì¡±'},
{id:'m4',n:'The Emperor',img:W+'c/c3/RWS_Tarot_04_Emperor.jpg',t:'major',m:'ê¶Œìœ„, ì•ˆì •, êµ¬ì¡°ì™€ ì§ˆì„œ',r:'ë…ì¬, ê²½ì§, í†µì œ'},
{id:'m5',n:'Hierophant',img:W+'8/8d/RWS_Tarot_05_Hierophant.jpg',t:'major',m:'ì „í†µ, ì§€í˜œ, ì˜ì  ì¸ë„',r:'ë…ë‹¨, í˜•ì‹ì£¼ì˜'},
{id:'m6',n:'The Lovers',img:W+'d/db/RWS_Tarot_06_Lovers.jpg',t:'major',m:'ì‚¬ë‘, ì„ íƒ, ì¡°í™”',r:'ë¶ˆí™”, ì˜ëª»ëœ ì„ íƒ'},
{id:'m7',n:'The Chariot',img:W+'9/9b/RWS_Tarot_07_Chariot.jpg',t:'major',m:'ìŠ¹ë¦¬, ì˜ì§€, ê²°ë‹¨ë ¥',r:'ë°©í–¥ ìƒì‹¤, ê³µê²©ì„±'},
{id:'m8',n:'Strength',img:W+'f/f5/RWS_Tarot_08_Strength.jpg',t:'major',m:'ìš©ê¸°, ì¸ë‚´, ë‚´ë©´ì˜ í˜',r:'ìê¸° ì˜ì‹¬, ë‚˜ì•½í•¨'},
{id:'m9',n:'The Hermit',img:W+'4/4d/RWS_Tarot_09_Hermit.jpg',t:'major',m:'ë‚´ë©´ íƒìƒ‰, ê³ ë…, ê¹¨ë‹¬ìŒ',r:'ê³ ë¦½, ì™¸ë¡œì›€'},
{id:'m10',n:'Wheel of Fortune',img:W+'3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg',t:'major',m:'ìš´ëª…ì˜ ì „í™˜, í–‰ìš´, ìˆœí™˜',r:'ë¶ˆìš´, ë³€í™” ì €í•­'},
{id:'m11',n:'Justice',img:W+'e/e0/RWS_Tarot_11_Justice.jpg',t:'major',m:'ì •ì˜, ê· í˜•, ì¸ê³¼ì‘ë³´',r:'ë¶ˆê³µì •, í¸ê²¬'},
{id:'m12',n:'Hanged Man',img:W+'2/2b/RWS_Tarot_12_Hanged_Man.jpg',t:'major',m:'í¬ìƒ, ìƒˆë¡œìš´ ì‹œê°',r:'ì§€ì—°, ë¬´ì˜ë¯¸í•œ í¬ìƒ'},
{id:'m13',n:'Death',img:W+'d/d7/RWS_Tarot_13_Death.jpg',t:'major',m:'ë³€í™”, ì¬íƒ„ìƒ, ì¢…ê²°',r:'ë³€í™” ì €í•­, ì •ì²´'},
{id:'m14',n:'Temperance',img:W+'f/f8/RWS_Tarot_14_Temperance.jpg',t:'major',m:'ì ˆì œ, ì¡°í™”, ì¸ë‚´',r:'ê³¼ì‰, ë¶ˆê· í˜•'},
{id:'m15',n:'The Devil',img:W+'5/55/RWS_Tarot_15_Devil.jpg',t:'major',m:'ìœ í˜¹, ì†ë°•, ê·¸ë¦¼ì',r:'í•´ë°©, êµ¬ì† íƒˆì¶œ'},
{id:'m16',n:'The Tower',img:W+'5/53/RWS_Tarot_16_Tower.jpg',t:'major',m:'ê¸‰ë³€, ê¹¨ë‹¬ìŒ, í•´ë°©',r:'ë³€í™” íšŒí”¼, ì§€ì—°ëœ ì¬ë‚œ'},
{id:'m17',n:'The Star',img:W+'d/db/RWS_Tarot_17_Star.jpg',t:'major',m:'í¬ë§, ì˜ê°, ì¹˜ìœ ',r:'ì ˆë§, ì‹ ë¢° ìƒì‹¤'},
{id:'m18',n:'The Moon',img:W+'7/7f/RWS_Tarot_18_Moon.jpg',t:'major',m:'í™˜ìƒ, ë¶ˆì•ˆ, ì ì¬ì˜ì‹',r:'í˜¼ë€ í•´ì†Œ, ì§„ì‹¤ ë°œê²¬'},
{id:'m19',n:'The Sun',img:W+'1/17/RWS_Tarot_19_Sun.jpg',t:'major',m:'ì„±ê³µ, ê¸°ì¨, í™œë ¥',r:'ë‚™ê´€ ê³¼ì‰, ì§€ì—°ëœ ì„±ê³µ'},
{id:'m20',n:'Judgement',img:W+'d/dd/RWS_Tarot_20_Judgement.jpg',t:'major',m:'ë¶€í™œ, ì‹¬íŒ, ë‚´ë©´ì˜ ë¶€ë¦„',r:'ìê¸° íšŒì˜, í›„íšŒ'},
{id:'m21',n:'The World',img:W+'f/ff/RWS_Tarot_21_World.jpg',t:'major',m:'ì™„ì„±, ì„±ì·¨, í†µí•©',r:'ë¯¸ì™„ì„±, ë¶€ì¡±ê°'},
{id:'w1',n:'Ace of Wands',img:W+'1/11/Wands01.jpg',t:'wands',m:'ì˜ê°, ìƒˆë¡œìš´ ì—´ì •',r:'ì§€ì—°, ì°½ì˜ë ¥ ë¶€ì¡±'},
{id:'w2',n:'Two of Wands',img:W+'0/0f/Wands02.jpg',t:'wands',m:'ê³„íš, ë¯¸ë˜ì˜ ê²°ì •',r:'ìš°ìœ ë¶€ë‹¨, ë‘ë ¤ì›€'},
{id:'w3',n:'Three of Wands',img:W+'f/ff/Wands03.jpg',t:'wands',m:'í™•ì¥, ê¸°íšŒì˜ ë„ë˜',r:'ì¥ì• ë¬¼, ì§€ì—°'},
{id:'w4',n:'Four of Wands',img:W+'a/a4/Wands04.jpg',t:'wands',m:'ì¶•í•˜, ì•ˆì •ëœ ê¸°ë°˜',r:'ë¶ˆì•ˆì •, ê°ˆë“±'},
{id:'w5',n:'Five of Wands',img:W+'9/9d/Wands05.jpg',t:'wands',m:'ê²½ìŸ, ê°ˆë“±',r:'íšŒí”¼, íƒ€í˜‘'},
{id:'w6',n:'Six of Wands',img:W+'3/3b/Wands06.jpg',t:'wands',m:'ìŠ¹ë¦¬, ì¸ì •',r:'ìë§Œ, ëª…ì„± ì‹¤ì¶”'},
{id:'w7',n:'Seven of Wands',img:W+'e/e4/Wands07.jpg',t:'wands',m:'ë°©ì–´, ë„ì „ì— ë§ì„¬',r:'í¬ê¸°, ì••ë„ë‹¹í•¨'},
{id:'w8',n:'Eight of Wands',img:W+'6/6b/Wands08.jpg',t:'wands',m:'ë¹ ë¥¸ ì§„í–‰, ì†Œì‹',r:'ì§€ì—°, ì¢Œì ˆ'},
{id:'w9',n:'Nine of Wands',img:W+'4/4d/Tarot_Nine_of_Wands.jpg',t:'wands',m:'ì¸ë‚´, ëˆê¸°',r:'í”¼ë¡œ, ì˜ì‹¬'},
{id:'w10',n:'Ten of Wands',img:W+'0/0b/Wands10.jpg',t:'wands',m:'ê³¼ì¤‘í•œ ì§, ì±…ì„',r:'ë²ˆì•„ì›ƒ, ìœ„ì„ í•„ìš”'},
{id:'w11',n:'Page of Wands',img:W+'6/6a/Wands11.jpg',t:'wands',m:'íƒí—˜, ì—´ì •ì  ì†Œì‹',r:'ë¯¸ìˆ™í•¨, ë°©í–¥ ìƒì‹¤'},
{id:'w12',n:'Knight of Wands',img:W+'1/16/Wands12.jpg',t:'wands',m:'ëª¨í—˜, ëŒ€ë‹´í•œ í–‰ë™',r:'ì„±ê¸‰í•¨, ë¬´ëª¨í•¨'},
{id:'w13',n:'Queen of Wands',img:W+'0/0d/Wands13.jpg',t:'wands',m:'ìì‹ ê°, ê²°ë‹¨ë ¥',r:'ì§ˆíˆ¬, ì´ê¸°ì‹¬'},
{id:'w14',n:'King of Wands',img:W+'c/ce/Wands14.jpg',t:'wands',m:'ë¦¬ë”ì‹­, ë¹„ì „',r:'ë…ì¬ì , ì¶©ë™ì '},
{id:'c1',n:'Ace of Cups',img:W+'3/36/Cups01.jpg',t:'cups',m:'ìƒˆë¡œìš´ ì‚¬ë‘, ê°ì •ì˜ ì‹œì‘',r:'ê°ì • ì–µì••, ê³µí—ˆ'},
{id:'c2',n:'Two of Cups',img:W+'f/f8/Cups02.jpg',t:'cups',m:'íŒŒíŠ¸ë„ˆì‹­, ìœ ëŒ€',r:'ë¶ˆê· í˜•, ë‹¨ì ˆ'},
{id:'c3',n:'Three of Cups',img:W+'7/7a/Cups03.jpg',t:'cups',m:'ìš°ì •, ì¶•ì œ',r:'ê³¼ì‰, ê³ ë¦½'},
{id:'c4',n:'Four of Cups',img:W+'3/35/Cups04.jpg',t:'cups',m:'ë¬´ê´€ì‹¬, ì¬ê³ ',r:'ìƒˆë¡œìš´ ì¸ì‹, ë™ê¸° ë¶€ì—¬'},
{id:'c5',n:'Five of Cups',img:W+'d/d7/Cups05.jpg',t:'cups',m:'ìƒì‹¤, í›„íšŒ',r:'ìˆ˜ìš©, íšŒë³µ'},
{id:'c6',n:'Six of Cups',img:W+'1/17/Cups06.jpg',t:'cups',m:'í–¥ìˆ˜, ìˆœìˆ˜í•œ ê¸°ì¨',r:'ê³¼ê±° ì§‘ì°©, ë¯¸ì„±ìˆ™'},
{id:'c7',n:'Seven of Cups',img:W+'a/ae/Cups07.jpg',t:'cups',m:'í™˜ìƒ, ì„ íƒì˜ ê³¼ë‹¤',r:'í˜„ì‹¤ ì§ì‹œ, ì§‘ì¤‘'},
{id:'c8',n:'Eight of Cups',img:W+'6/60/Cups08.jpg',t:'cups',m:'ë– ë‚¨, ë” ê¹Šì€ ì˜ë¯¸ ì¶”êµ¬',r:'ë°©í™©, ë‘ë ¤ì›€ìœ¼ë¡œ ë¨¸ë¬´ë¦„'},
{id:'c9',n:'Nine of Cups',img:W+'2/24/Cups09.jpg',t:'cups',m:'ë§Œì¡±, ì†Œì› ì„±ì·¨',r:'íƒìš•, ë¶ˆë§Œì¡±'},
{id:'c10',n:'Ten of Cups',img:W+'8/84/Cups10.jpg',t:'cups',m:'ê°€ì •ì˜ í–‰ë³µ, ì¡°í™”',r:'ê°€ì • ë¶ˆí™”, ê¸°ëŒ€ ì¢Œì ˆ'},
{id:'c11',n:'Page of Cups',img:W+'a/ad/Cups11.jpg',t:'cups',m:'ì§ê´€ì  ë©”ì‹œì§€, ìƒìƒë ¥',r:'ê°ì •ì  ë¯¸ìˆ™'},
{id:'c12',n:'Knight of Cups',img:W+'f/fa/Cups12.jpg',t:'cups',m:'ë¡œë§¨ìŠ¤, ì œì•ˆ',r:'ë³€ë•, ë¹„í˜„ì‹¤ì  ê¸°ëŒ€'},
{id:'c13',n:'Queen of Cups',img:W+'6/62/Cups13.jpg',t:'cups',m:'ê³µê°, ì§ê´€',r:'ê°ì • ì˜ì¡´, ë¶ˆì•ˆì •'},
{id:'c14',n:'King of Cups',img:W+'0/04/Cups14.jpg',t:'cups',m:'ê°ì •ì  ê· í˜•, ê´€ëŒ€í•¨',r:'ê°ì • ì¡°ì¢…, ëƒ‰ë‹´'},
{id:'s1',n:'Ace of Swords',img:W+'1/1a/Swords01.jpg',t:'swords',m:'ëª…í™•í•œ ì‚¬ê³ , ì§„ì‹¤',r:'í˜¼ë€, ì˜ëª»ëœ íŒë‹¨'},
{id:'s2',n:'Two of Swords',img:W+'9/9e/Swords02.jpg',t:'swords',m:'ê²°ì •ì˜ êµì°©, ê· í˜•',r:'ì •ë³´ ê³¼ë¶€í•˜, ì„ íƒ íšŒí”¼'},
{id:'s3',n:'Three of Swords',img:W+'0/02/Swords03.jpg',t:'swords',m:'ìŠ¬í””, ë§ˆìŒì˜ ìƒì²˜',r:'ì¹˜ìœ ì˜ ì‹œì‘, ìš©ì„œ'},
{id:'s4',n:'Four of Swords',img:W+'b/bf/Swords04.jpg',t:'swords',m:'íœ´ì‹, íšŒë³µ',r:'ì†Œì§„, ë¶ˆì•ˆ'},
{id:'s5',n:'Five of Swords',img:W+'2/23/Swords05.jpg',t:'swords',m:'íŒ¨ë°°, ê°ˆë“±ì˜ ë',r:'í™”í•´, ê³¼ê±° ì²­ì‚°'},
{id:'s6',n:'Six of Swords',img:W+'2/29/Swords06.jpg',t:'swords',m:'ì „í™˜, ì´ë™',r:'ì •ì²´, ë¯¸í•´ê²° ë¬¸ì œ'},
{id:'s7',n:'Seven of Swords',img:W+'3/34/Swords07.jpg',t:'swords',m:'ì „ëµ, ì€ë°€í•œ í–‰ë™',r:'ì–‘ì‹¬ì˜ ê°€ì±…'},
{id:'s8',n:'Eight of Swords',img:W+'a/a7/Swords08.jpg',t:'swords',m:'êµ¬ì†, ìê¸° ì œí•œ',r:'í•´ë°©, ìƒˆë¡œìš´ ì‹œê°'},
{id:'s9',n:'Nine of Swords',img:W+'2/2f/Swords09.jpg',t:'swords',m:'ë¶ˆì•ˆ, ì•…ëª½',r:'í¬ë§, ê±±ì • í•´ì†Œ'},
{id:'s10',n:'Ten of Swords',img:W+'d/d4/Swords10.jpg',t:'swords',m:'ë, ìµœí•˜ì ì—ì„œ ì¬ê¸°',r:'ì¬ìƒ, íšŒë³µì˜ ì¡°ì§'},
{id:'s11',n:'Page of Swords',img:W+'4/4c/Swords11.jpg',t:'swords',m:'í˜¸ê¸°ì‹¬, ê²½ê³„',r:'í—˜ë‹´, ë¬´ê³„íš'},
{id:'s12',n:'Knight of Swords',img:W+'b/b0/Swords12.jpg',t:'swords',m:'ëŒì§„, ì•¼ë§',r:'ë¬´ëª¨í•¨, ê³µê²©ì„±'},
{id:'s13',n:'Queen of Swords',img:W+'d/d4/Swords13.jpg',t:'swords',m:'ë…ë¦½, ëª…ì„í•œ íŒë‹¨',r:'ëƒ‰ì •í•¨, í¸í˜‘'},
{id:'s14',n:'King of Swords',img:W+'3/33/Swords14.jpg',t:'swords',m:'ê¶Œìœ„, ì§€ì  í˜',r:'ê¶Œë ¥ ë‚¨ìš©, ë¹„ì •í•¨'},
{id:'p1',n:'Ace of Pentacles',img:W+'f/fd/Pents01.jpg',t:'pent',m:'ìƒˆë¡œìš´ ì¬ì •ì  ê¸°íšŒ',r:'ê¸°íšŒ ë†“ì¹¨, ë¶ˆì•ˆì •'},
{id:'p2',n:'Two of Pentacles',img:W+'9/9f/Pents02.jpg',t:'pent',m:'ê· í˜•, ì ì‘',r:'ë¶ˆê· í˜•, ê³¼ë¶€í•˜'},
{id:'p3',n:'Three of Pentacles',img:W+'4/42/Pents03.jpg',t:'pent',m:'í˜‘ë ¥, ì¥ì¸ ì •ì‹ ',r:'ë¶ˆí˜‘í™”ìŒ, ë¯¸ìˆ™'},
{id:'p4',n:'Four of Pentacles',img:W+'3/35/Pents04.jpg',t:'pent',m:'ì•ˆì •, ì†Œìœ ìš•',r:'ì¸ìƒ‰, ì§‘ì°©'},
{id:'p5',n:'Five of Pentacles',img:W+'9/96/Pents05.jpg',t:'pent',m:'ê¶í•, ê³ ë¦½',r:'íšŒë³µ, ë„ì›€ì˜ ì†ê¸¸'},
{id:'p6',n:'Six of Pentacles',img:W+'a/a6/Pents06.jpg',t:'pent',m:'ê´€ëŒ€í•¨, ë‚˜ëˆ”',r:'ë¹š, ì¡°ê±´ë¶€ ë„ì›€'},
{id:'p7',n:'Seven of Pentacles',img:W+'6/6a/Pents07.jpg',t:'pent',m:'ì¸ë‚´, ì¥ê¸°ì  íˆ¬ì',r:'ì¡°ê¸‰í•¨, ë³´ìƒ ë¶€ì¡±'},
{id:'p8',n:'Eight of Pentacles',img:W+'4/49/Pents08.jpg',t:'pent',m:'ìˆ™ë ¨, ê·¼ë©´',r:'ì™„ë²½ì£¼ì˜, ì§€ë£¨í•¨'},
{id:'p9',n:'Nine of Pentacles',img:W+'f/f0/Pents09.jpg',t:'pent',m:'í’ìš”, ìë¦½',r:'ê³¼ì†Œë¹„, ì˜ì¡´'},
{id:'p10',n:'Ten of Pentacles',img:W+'4/42/Pents10.jpg',t:'pent',m:'ìœ ì‚°, ê°€ë¬¸ì˜ ë²ˆì˜',r:'ì¬ì • ì†ì‹¤, ê°€ì¡± ê°ˆë“±'},
{id:'p11',n:'Page of Pentacles',img:W+'e/ec/Pents11.jpg',t:'pent',m:'í•™ìŠµ, ìƒˆë¡œìš´ ê¸°ìˆ ',r:'ë¬´ê³„íš, ê¸°íšŒ ë†“ì¹¨'},
{id:'p12',n:'Knight of Pentacles',img:W+'d/d5/Pents12.jpg',t:'pent',m:'ì„±ì‹¤, ê¾¸ì¤€í•œ ë…¸ë ¥',r:'ì •ì²´, ê²Œìœ¼ë¦„'},
{id:'p13',n:'Queen of Pentacles',img:W+'8/88/Pents13.jpg',t:'pent',m:'í’ìš”ë¡œìš´ ëŒë´„, ì‹¤ìš©',r:'ìê¸° ë°©ì¹˜, ë¶ˆì•ˆì •'},
{id:'p14',n:'King of Pentacles',img:W+'1/1c/Pents14.jpg',t:'pent',m:'ë¶€, ì‚¬ì—… ì„±ê³µ',r:'íƒìš•, ë¬¼ì§ˆ ë§ŒëŠ¥ì£¼ì˜'},
];

// â•â•â•â•â•â•â• SPREADS â•â•â•â•â•â•â•
const SP={
one:{name:'ì› ì¹´ë“œ',en:'One Card',cnt:1,pos:['í˜„ì¬ ë©”ì‹œì§€']},
three:{name:'ì“°ë¦¬ ì¹´ë“œ',en:'Three Card',cnt:3,pos:['ê³¼ê±°','í˜„ì¬','ë¯¸ë˜']},
celtic:{name:'ì¼ˆíŠ¸ ì‹­ìê°€',en:'Celtic Cross',cnt:10,pos:['í˜„ì¬ ìƒí™©','ë„ì „/ì¥ì• ','ê³¼ê±°ì˜ ê¸°ì´ˆ','ìµœê·¼ ê³¼ê±°','ê°€ëŠ¥í•œ ê²°ê³¼','ê°€ê¹Œìš´ ë¯¸ë˜','ìê¸° ìì‹ ','í™˜ê²½','í¬ë§/ë‘ë ¤ì›€','ìµœì¢… ê²°ê³¼']},
tree:{name:'ìƒëª…ì˜ ë‚˜ë¬´',en:'Tree of Life',cnt:10,pos:['ì™•ê´€(ì¼€í…Œë¥´)','ì§€í˜œ(í˜¸í¬ë§ˆ)','ì´í•´(ë¹„ë‚˜)','ìë¹„(í—¤ì„¸ë“œ)','ì‹¬íŒ(ê²Œë¶€ë¼)','ì•„ë¦„ë‹¤ì›€(í‹°í˜ë ˆíŠ¸)','ìŠ¹ë¦¬(ë„¤ì§œí)','ì˜ê´‘(í˜¸ë“œ)','ê¸°ì´ˆ(ì˜ˆì†Œë“œ)','ì™•êµ­(ë§ì¿ íŠ¸)']},
horseshoe:{name:'ë§ ë°œêµ½',en:'Horseshoe',cnt:7,pos:['ê³¼ê±°','í˜„ì¬','ë¯¸ë˜','ìµœì„ ì˜ í–‰ë™','íƒ€ì¸ì˜ ì˜í–¥','ì¥ì• ë¬¼','ê²°ê³¼']},
fullmoon:{name:'ë³´ë¦„ë‹¬',en:'Full Moon',cnt:6,pos:['í˜„ì¬ ì—ë„ˆì§€','ë‚´ë©´ì˜ ìš•êµ¬','ì™¸ë¶€ ì˜í–¥','ë¬´ì˜ì‹','ì˜ì‹ì  ì¸ì‹','í†µí•©/ê²°ê³¼']},
};

// â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•
let curSp='three',st='idle',deck=[],sel=[],cCards=[],imgCache={};
const cv=document.getElementById('tarotCanvas'),cx=cv.getContext('2d');
let CW,CH,backCv;

// â•â•â•â•â•â•â• UTIL â•â•â•â•â•â•â•
function shuf(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}
function lerp(a,b,t){return a+(b-a)*t}
function easeOut(t){return 1-Math.pow(1-t,3)}
function gCS(){const s=getComputedStyle(document.documentElement);CW=parseFloat(s.getPropertyValue('--cw'));CH=parseFloat(s.getPropertyValue('--ch'))}

// â•â•â•â•â•â•â• CANVAS â•â•â•â•â•â•â•
function resize(){
  const wr=document.getElementById('canvasWrap');
  const dpr=window.devicePixelRatio||1;
  cv.width=wr.clientWidth*dpr;cv.height=wr.clientHeight*dpr;
  cv.style.width=wr.clientWidth+'px';cv.style.height=wr.clientHeight+'px';
  cx.setTransform(dpr,0,0,dpr,0,0);
  gCS();makeBack();
}

function makeBack(){
  backCv=document.createElement('canvas');backCv.width=CW;backCv.height=CH;
  const x=backCv.getContext('2d');
  x.fillStyle='#1a0f2e';x.beginPath();x.roundRect(0,0,CW,CH,5);x.fill();
  x.strokeStyle='rgba(212,168,67,.3)';x.lineWidth=1.5;x.beginPath();x.roundRect(1,1,CW-2,CH-2,4);x.stroke();
  x.strokeStyle='rgba(212,168,67,.12)';x.lineWidth=1;x.beginPath();x.roundRect(5,5,CW-10,CH-10,3);x.stroke();
  x.fillStyle='rgba(212,168,67,.04)';
  for(let i=0;i<CW;i+=10)for(let j=0;j<CH;j+=10){x.save();x.translate(i+5,j+5);x.rotate(Math.PI/4);x.fillRect(-2.5,-2.5,5,5);x.restore()}
  x.fillStyle='rgba(212,168,67,.25)';x.font=`${Math.floor(CW*.28)}px serif`;x.textAlign='center';x.textBaseline='middle';x.fillText('âœ¦',CW/2,CH/2);
}

function loadImg(src){return new Promise(r=>{if(imgCache[src])return r(imgCache[src]);const i=new Image();i.crossOrigin='anonymous';i.onload=()=>{imgCache[src]=i;r(i)};i.onerror=()=>r(null);i.src=src})}

let floatRAF=0,floatT=0;
function drawCard(c){
  cx.save();
  const t=floatT;
  // floating offset: each card has unique phase based on idx
  const ph=c.idx*1.7+c.idx*c.idx*.3;
  const floatY=Math.sin(t*1.2+ph)*4+Math.sin(t*0.7+ph*1.3)*2.5;
  const floatX=Math.cos(t*0.8+ph*.9)*1.5;
  const floatAng=Math.sin(t*0.5+ph*1.1)*0.8;
  const floatSc=1+Math.sin(t*0.9+ph)*0.008;
  // shadow depth pulses with float height
  const shadowD=8+floatY*0.6;
  const shadowB=12+Math.abs(floatY)*1.2;

  cx.globalAlpha=c.a??1;
  cx.translate(c.x+floatX,c.y+floatY);
  cx.rotate(((c.ang||0)+floatAng)*Math.PI/180);
  cx.scale((c.sc||1)*floatSc,(c.sc||1)*floatSc);

  // dynamic shadow â€” deeper when card is "higher"
  cx.shadowColor='rgba(0,0,0,.4)';cx.shadowBlur=shadowB;cx.shadowOffsetY=shadowD;

  if(c.flip&&c.fImg){
    cx.beginPath();cx.roundRect(-CW/2,-CH/2,CW,CH,5);cx.clip();
    if(c.rev){cx.save();cx.rotate(Math.PI);cx.drawImage(c.fImg,-CW/2,-CH/2,CW,CH);cx.restore()}
    else cx.drawImage(c.fImg,-CW/2,-CH/2,CW,CH);
    // gold glow border â€” pulses gently
    cx.shadowColor='transparent';
    const glowA=.35+Math.sin(t*1.5+ph)*.1;
    cx.strokeStyle=`rgba(212,168,67,${glowA})`;cx.lineWidth=1.5;
    cx.beginPath();cx.roundRect(-CW/2,-CH/2,CW,CH,5);cx.stroke();
    // soft outer glow
    cx.shadowColor=`rgba(212,168,67,${.08+Math.sin(t+ph)*.04})`;cx.shadowBlur=18;
    cx.strokeStyle='transparent';cx.beginPath();cx.roundRect(-CW/2,-CH/2,CW,CH,5);cx.stroke();
  }else{
    cx.drawImage(backCv,-CW/2,-CH/2,CW,CH);
  }
  // hover glow
  if(c.hov&&!c.flip){
    cx.shadowColor='rgba(212,168,67,.15)';cx.shadowBlur=20;
    cx.strokeStyle='rgba(212,168,67,.55)';cx.lineWidth=1.5;
    cx.beginPath();cx.roundRect(-CW/2,-CH/2,CW,CH,5);cx.stroke();
    cx.fillStyle='rgba(212,168,67,.06)';cx.beginPath();cx.roundRect(-CW/2,-CH/2,CW,CH,5);cx.fill();
  }
  cx.restore();
}

function render(){
  const w=cv.clientWidth,h=cv.clientHeight;cx.clearRect(0,0,w,h);
  const t=floatT;
  // â”€â”€ Starfield background â”€â”€
  for(let i=0;i<50;i++){
    const sx=(Math.sin(i*127.1+t*.08)*.5+.5)*w;
    const sy=(Math.cos(i*311.7+t*.06)*.5+.5)*h;
    const bright=.5+Math.sin(i*73.3+t*1.5)*.5;
    const sz=.4+bright*1.0;
    cx.fillStyle=`rgba(212,168,67,${.008+bright*.018})`;
    cx.beginPath();cx.arc(sx,sy,sz,0,Math.PI*2);cx.fill();
  }
  // â”€â”€ Subtle mist / nebula â”€â”€
  const grd=cx.createRadialGradient(w/2,h*.45,0,w/2,h*.45,w*.5);
  grd.addColorStop(0,`rgba(107,63,160,${.03+Math.sin(t*.3)*.01})`);
  grd.addColorStop(1,'transparent');
  cx.fillStyle=grd;cx.fillRect(0,0,w,h);

  cCards.forEach(drawCard);
}

// â”€â”€ Continuous floating animation loop â”€â”€
function floatLoop(now){
  floatT=now*.001;
  render();
  floatRAF=requestAnimationFrame(floatLoop);
}
floatRAF=requestAnimationFrame(floatLoop);

// â•â•â•â•â•â•â• ANIMATION â•â•â•â•â•â•â•
function animCards(cfgs,dur,done){
  const s0=cCards.map(c=>({x:c.x,y:c.y,ang:c.ang||0,sc:c.sc||1,a:c.a??1}));
  const t0=performance.now();
  let finished=false;
  (function tick(now){
    if(finished)return;
    const el=now-t0;let allD=true;
    cCards.forEach((c,i)=>{
      const cf=cfgs[i];if(!cf)return;
      const lt=Math.max(0,el-(cf.dl||0)),p=Math.min(1,lt/dur),e=easeOut(p);
      if(p<1)allD=false;
      const tg=cf.tg;
      c.x=lerp(s0[i].x,tg.x,e);c.y=lerp(s0[i].y,tg.y,e);
      c.ang=lerp(s0[i].ang,tg.ang??0,e);c.sc=lerp(s0[i].sc,tg.sc??1,e);c.a=lerp(s0[i].a,tg.a??1,e);
    });
    if(!allD)requestAnimationFrame(tick);
    else{finished=true;if(done)done()}
  })(t0);
}

// â•â•â•â•â•â•â• SHUFFLE â•â•â•â•â•â•â•
function startShuffle(){
  st='shuf';
  document.getElementById('mainBtn').disabled=true;
  document.getElementById('stxt').textContent='ì…”í”Œ ì¤‘...';
  deck=shuf(D.map(c=>({...c,reversed:Math.random()<.4})));sel=[];updateDots();
  const w=cv.clientWidth,h=cv.clientHeight,N=28;
  cCards=[];for(let i=0;i<N;i++)cCards.push({x:w/2,y:h/2,ang:0,sc:1,a:1,idx:i});
  render();
  // scatter
  animCards(cCards.map((c,i)=>({tg:{x:w/2+(Math.random()-.5)*w*.6,y:h/2+(Math.random()-.5)*h*.45,ang:(Math.random()-.5)*110},dl:i*12})),500,()=>{
    let cy=0;
    (function wash(){
      if(cy>=3){gather();return}
      animCards(cCards.map((c,i)=>{const a=(cy*120+(i/N)*360+Math.random()*35)*Math.PI/180,rr=40+Math.random()*Math.min(w,h)*.22;return{tg:{x:w/2+Math.cos(a)*rr,y:h/2+Math.sin(a)*rr,ang:(Math.random()-.5)*140},dl:i*4}}),420,()=>{cy++;wash()});
    })();
  });
  function gather(){
    const w=cv.clientWidth,h=cv.clientHeight;
    animCards(cCards.map((c,i)=>({tg:{x:w/2+(Math.random()-.5)*25,y:h/2+(Math.random()-.5)*18,ang:(Math.random()-.5)*8},dl:i*6})),350,()=>{
      animCards(cCards.map((c,i)=>({tg:{x:w/2,y:h/2-i*.7,ang:0},dl:0})),250,()=>{setTimeout(spread,250)});
    });
  }
}

function spread(){
  st='spread';const w=cv.clientWidth,h=cv.clientHeight,N=cCards.length;
  const totAng=110,startA=-totAng/2,pivY=h*1.08,rad=Math.min(h*.82,w*.46);
  animCards(cCards.map((c,i)=>{
    const ad=startA+(totAng/(N-1))*i,ar=(ad-90)*Math.PI/180;
    c._fa=ad;c._fx=w/2+Math.cos(ar)*rad;c._fy=pivY+Math.sin(ar)*rad;
    return{tg:{x:c._fx,y:c._fy,ang:ad,sc:1,a:1},dl:i*18};
  }),550,()=>{
    st='sel';
    document.getElementById('stxt').textContent=SP[curSp].pos[0]+' ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”';
    document.getElementById('mainBtn').style.display='none';
    listen();
  });
}

// â•â•â•â•â•â•â• INTERACTION â•â•â•â•â•â•â•
function listen(){cv.addEventListener('pointermove',onMove);cv.addEventListener('pointerdown',onDown)}
function unlisten(){cv.removeEventListener('pointermove',onMove);cv.removeEventListener('pointerdown',onDown)}

function hit(px,py){
  for(let i=cCards.length-1;i>=0;i--){
    const c=cCards[i];if(c.flip||c.dis)continue;
    // account for floating offset
    const ph=c.idx*1.7+c.idx*c.idx*.3;
    const fy=Math.sin(floatT*1.2+ph)*4+Math.sin(floatT*0.7+ph*1.3)*2.5;
    const fx=Math.cos(floatT*0.8+ph*.9)*1.5;
    const dx=px-(c.x+fx),dy=py-(c.y+fy),a=-(c.ang||0)*Math.PI/180;
    const rx=dx*Math.cos(a)-dy*Math.sin(a),ry=dx*Math.sin(a)+dy*Math.cos(a);
    if(Math.abs(rx)<CW/2+4&&Math.abs(ry)<CH/2+4)return i;
  }return-1;
}
function cpos(e){const r=cv.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}}

function onMove(e){
  if(st!=='sel')return;const{x,y}=cpos(e),h=hit(x,y);
  cCards.forEach((c,i)=>{
    if(c.flip||c.dis)return;
    if(i===h){if(!c.hov){c.hov=true;c._oy=c.y;c.y-=8;c.sc=1.08}}
    else if(c.hov){c.hov=false;if(c._oy!==undefined){c.y=c._oy;c._oy=undefined}c.sc=1}
  });
}

function onDown(e){
  if(st!=='sel')return;const{x,y}=cpos(e),hi=hit(x,y);if(hi<0)return;
  const sp=SP[curSp],c=cCards[hi],dc=deck[hi%deck.length];
  c.flip=true;c.rev=dc.reversed;c.hov=false;if(c._oy!==undefined){c.y=c._oy;c._oy=undefined}c.sc=1.08;
  loadImg(dc.img).then(img=>{c.fImg=img;render()});
  sel.push({card:dc,cc:c,pos:sp.pos[sel.length]});updateDots();
  if(sel.length<sp.cnt){document.getElementById('stxt').textContent=sp.pos[sel.length]+' ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”'}
  else{
    document.getElementById('stxt').textContent='ìš´ëª…ì„ ì½ëŠ” ì¤‘...';
    cCards.forEach(c=>{if(!c.flip){c.dis=true;c.a=.12}});
    unlisten();st='done';setTimeout(showRes,1e3);
  }
}

// â•â•â•â•â•â•â• RESULT â•â•â•â•â•â•â•
function showRes(){
  const sp=SP[curSp],ov=document.getElementById('rov'),bd=document.getElementById('rovB');
  document.getElementById('rovT').textContent='âœ¦ '+sp.name+' í•´ì„ âœ¦';
  let h='<div class="rcrow">';
  sel.forEach(s=>{const rv=s.card.reversed;
    h+=`<div class="rcm"><img src="${s.card.img}" style="${rv?'transform:rotate(180deg)':''}"><div class="p">${s.pos}</div><div class="n">${s.card.n}</div><div class="d" style="color:${rv?'#e85454':'#7be854'}">${rv?'ì—­ë°©í–¥':'ì •ë°©í–¥'}</div></div>`;
  });h+='</div>';
  const q=document.getElementById('qInput').value.trim(),ak=localStorage.getItem('gemini_api_key');
  if(!ak){h+=`<div class="aw">âš ï¸ Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br><a href="#" onclick="closeR();showPage('settings');return false">ì„¤ì • í˜ì´ì§€</a>ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;h+=fallback()}
  else h+='<div class="ail" id="aiL">AIê°€ íƒ€ë¡œë¥¼ í•´ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>';
  bd.innerHTML=h;ov.classList.add('show');
  if(ak)callAI(ak,q);
  saveHist(q);
}

function fallback(){
  let h='<div class="air">';
  sel.forEach(s=>{const rv=s.card.reversed;h+=`\nã€${s.pos}ã€‘ ${s.card.n} (${rv?'ì—­ë°©í–¥':'ì •ë°©í–¥'})\n${rv?s.card.r:s.card.m}\n`});
  return h+'</div>';
}

async function callAI(ak, q) {
  const sp = SP[curSp];
  const ci = sel.map(s => {
    const rv = s.card.reversed;
    return `- ${s.pos}: ${s.card.n} (${rv ? 'ì—­ë°©í–¥' : 'ì •ë°©í–¥'}) â€” ${rv ? s.card.r : s.card.m}`;
  }).join('\n');

  const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ íƒ€ë¡œ ë¦¬ë”ì…ë‹ˆë‹¤. ë¼ì´ë”-ì›¨ì´íŠ¸-ìŠ¤ë¯¸ìŠ¤ ë±ì„ ì‚¬ìš©í•œ ${sp.name}(${sp.en}) ìŠ¤í”„ë ˆë“œ ë¦¬ë”©ì„ í•´ì„í•´ì£¼ì„¸ìš”.\n\n${q ? 'ì§ˆë¬¸: ' + q + '\n\n' : ''}ì„ íƒëœ ì¹´ë“œ:\n${ci}\n\nê° ì¹´ë“œì˜ ìœ„ì¹˜ë³„ ì˜ë¯¸ë¥¼ ìƒì„¸íˆ í•´ì„í•˜ê³ , ì¹´ë“œë“¤ ê°„ì˜ ê´€ê³„ì™€ ì „ì²´ì ì¸ ë©”ì‹œì§€ë¥¼ ì¢…í•©í•´ì£¼ì„¸ìš”. í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ë˜ ì¹´ë“œ ì´ë¦„ì€ ì˜ë¬¸ì„ ë³‘ê¸°í•´ì£¼ì„¸ìš”. í•´ì„ì´ ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ ìš”ì•½í•´ì„œ í•´ì£¼ì„¸ìš”.`;

  try {
    // ğŸŒŸ ëª¨ë¸ëª…ì„ gemini-1.5-flashë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${ak}`;
    
    const res = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });

    // 429 ì—ëŸ¬(Too Many Requests) ì „ìš© ì²˜ë¦¬
    if (res.status === 429) {
      throw new Error("ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„(ì•½ 1ë¶„) ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }

    if (!res.ok) throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);

    const data = await res.json();
    const txt = data?.candidates?.[0]?.content?.parts?.[0]?.text;

    const el = document.getElementById('aiL');
    if (el) {
      if (txt) {
        // ì¤„ë°”ê¿ˆ ìœ ì§€ ë° í…ìŠ¤íŠ¸ ì‚½ì…
        el.outerHTML = '<div class="air">' + txt.replace(/\n/g, '<br>') + '</div>';
      } else {
        el.outerHTML = '<div class="aw">âš ï¸ AI ì‘ë‹µ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>' + fallback();
      }
    }

    // íˆìŠ¤í† ë¦¬ ì €ì¥
    const hist = getHist();
    if (hist.length) {
      hist[0].ai = txt || '';
      localStorage.setItem('tarot_hist', JSON.stringify(hist));
    }

  } catch (e) {
    const el = document.getElementById('aiL');
    if (el) {
      el.outerHTML = `<div class="aw">âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ${e.message}</div>` + (typeof fallback === 'function' ? fallback() : '');
    }
  }
}

function closeR(){document.getElementById('rov').classList.remove('show')}
function restart(){closeR();resetT()}

// â•â•â•â•â•â•â• HISTORY â•â•â•â•â•â•â•
function getHist(){try{return JSON.parse(localStorage.getItem('tarot_hist')||'[]')}catch{return[]}}
function saveHist(q){
  const h=getHist();
  h.unshift({dt:new Date().toISOString(),sp:curSp,spN:SP[curSp].name,q:q||'',cards:sel.map(s=>({n:s.card.n,id:s.card.id,pos:s.pos,rev:s.card.reversed,m:s.card.reversed?s.card.r:s.card.m,img:s.card.img})),ai:''});
  if(h.length>50)h.length=50;localStorage.setItem('tarot_hist',JSON.stringify(h));
}

function renderHist(){
  const el=document.getElementById('hList'),h=getHist();
  if(!h.length){el.innerHTML='<div class="hempty">ì•„ì§ íƒ€ë¡œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë¦¬ë”©ì„ ì‹œì‘í•´ë³´ì„¸ìš”! âœ¦</div>';return}
  el.innerHTML=h.map((it,i)=>`<div class="hitem" onclick="viewH(${i})"><div class="htop"><span class="hsp">${it.spN}</span><span class="hdate">${new Date(it.dt).toLocaleDateString('ko')} ${new Date(it.dt).toLocaleTimeString('ko',{hour:'2-digit',minute:'2-digit'})}</span></div><div class="hq">${it.q||'(ì§ˆë¬¸ ì—†ìŒ)'}</div><div class="hchips">${it.cards.map(c=>'<span class="hchip">'+c.n+(c.rev?' â†“':'')+'</span>').join('')}</div></div>`).join('');
}

function viewH(i){
  const h=getHist(),it=h[i];if(!it)return;
  const ov=document.getElementById('rov'),bd=document.getElementById('rovB');
  document.getElementById('rovT').textContent='âœ¦ '+it.spN+' âœ¦';
  let html='<div class="rcrow">';
  it.cards.forEach(c=>{html+=`<div class="rcm"><img src="${c.img}" style="${c.rev?'transform:rotate(180deg)':''}"><div class="p">${c.pos}</div><div class="n">${c.n}</div><div class="d" style="color:${c.rev?'#e85454':'#7be854'}">${c.rev?'ì—­ë°©í–¥':'ì •ë°©í–¥'}</div></div>`});
  html+='</div>';
  if(it.q)html+=`<div style="font-size:.78rem;color:var(--text2);margin:6px 0;font-style:italic">ì§ˆë¬¸: ${it.q}</div>`;
  if(it.ai)html+='<div class="air">'+it.ai.replace(/\n/g,'<br>')+'</div>';
  else{html+='<div class="air">';it.cards.forEach(c=>{html+=`\nã€${c.pos}ã€‘ ${c.n} (${c.rev?'ì—­ë°©í–¥':'ì •ë°©í–¥'})\n${c.m}\n`});html+='</div>'}
  bd.innerHTML=html;ov.classList.add('show');
}

// â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•
function initSet(){
  document.getElementById('apiInput').value=localStorage.getItem('gemini_api_key')||'';
  curSp=localStorage.getItem('tarot_sp')||'three';
  const g=document.getElementById('spGrid');
  g.innerHTML=Object.entries(SP).map(([k,v])=>`<div class="spopt${k===curSp?' act':''}" data-s="${k}" onclick="selSp('${k}')"><div class="sn">${v.name}</div><div class="sc">${v.cnt}ì¥</div></div>`).join('');
  updSpLbl();
}

function saveKey(){localStorage.setItem('gemini_api_key',document.getElementById('apiInput').value.trim());const m=document.getElementById('keySvd');m.classList.add('show');setTimeout(()=>m.classList.remove('show'),2e3)}

function selSp(k){
  curSp=k;localStorage.setItem('tarot_sp',k);
  document.querySelectorAll('.spopt').forEach(e=>e.classList.toggle('act',e.dataset.s===k));
  updSpLbl();const m=document.getElementById('spSvd');m.classList.add('show');setTimeout(()=>m.classList.remove('show'),2e3);
  if(st!=='idle')resetT();
}

function updSpLbl(){document.getElementById('spLabel').textContent=SP[curSp].name+' ('+SP[curSp].cnt+'ì¥)';updateDots()}
function updateDots(){const sp=SP[curSp],r=document.getElementById('dotRow');r.innerHTML='';for(let i=0;i<sp.cnt;i++){const d=document.createElement('div');d.className='dot';if(i<sel.length)d.classList.add('on');r.appendChild(d)}}

// â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•
function showPage(n){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('pg-'+n).classList.add('active');
  document.querySelector('.nav-btn[data-p="'+n+'"]').classList.add('active');
  if(n==='history')renderHist();
  if(n==='tarot')resize();
}

// â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•
function onMain(){if(st==='idle')startShuffle()}
function resetT(){
  st='idle';unlisten();cCards=[];sel=[];
  updateDots();
  document.getElementById('stxt').textContent='ì¹´ë“œë¥¼ ì…”í”Œí•˜ì„¸ìš”';
  const btn=document.getElementById('mainBtn');btn.disabled=false;btn.style.display='';
}

// â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•
window.addEventListener('resize',()=>{resize()});
initSet();resize();
</script>
</body>
</html>
